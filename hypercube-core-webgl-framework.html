<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HypercubeCore Data Visualization Platform</title>
    <script>
        (function () {
            const params = new URLSearchParams(window.location.search || '');
            const embedMode = params.get('mode') === 'embed';
            if (!embedMode) {
                return;
            }
            document.documentElement.dataset.pppEmbed = 'true';
            const existingConfig = (typeof window !== 'undefined' && window.PPP_CONFIG && typeof window.PPP_CONFIG === 'object')
                ? { ...window.PPP_CONFIG }
                : {};
            const existingSonic = existingConfig.sonicGeometry && typeof existingConfig.sonicGeometry === 'object'
                ? existingConfig.sonicGeometry
                : {};
            window.PPP_CONFIG = {
                ...existingConfig,
                embed: true,
                exposeApi: false,
                autoStream: existingConfig.autoStream !== undefined ? existingConfig.autoStream : true,
                sonicGeometry: {
                    ...existingSonic,
                    autoEnable: existingSonic.autoEnable ?? false,
                    mode: existingSonic.mode || existingSonic.outputMode || 'analysis'
                }
            };
            if (typeof document !== 'undefined') {
                document.addEventListener('DOMContentLoaded', () => {
                    if (document.body) {
                        document.body.dataset.embed = 'true';
                    }
                });
            }
        })();
    </script>
    <script type="module" src="./scripts/console-protect.js" defer></script>
    <style>
        :root {
            color-scheme: dark;
        }
        * {
            box-sizing: border-box;
        }
        html, body {
            margin: 0;
            height: 100%;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background: #020412;
            color: #e8f6ff;
        }
        body {
            overflow: hidden;
        }
        #visualizerCanvas {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            display: block;
            background: radial-gradient(circle at center, rgba(16, 40, 76, 0.35), rgba(2, 4, 18, 0.95));
        }
        #spinorOverlay {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            display: block;
            pointer-events: none;
            mix-blend-mode: screen;
            z-index: 5;
        }
        #controlPanel {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            width: min(440px, 90vw);
            max-height: 92vh;
            overflow-y: auto;
            padding: 1.5rem;
            border-radius: 1.25rem;
            background: rgba(6, 14, 32, 0.86);
            border: 1px solid rgba(99, 210, 255, 0.25);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(14px);
            z-index: 10;
        }
        #controlPanel h1 {
            margin: 0;
            font-size: 1.6rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: #7cd8ff;
        }
        #controlPanel p.description {
            margin: 0.75rem 0 1.25rem;
            font-size: 0.95rem;
            line-height: 1.45;
            color: rgba(216, 236, 255, 0.82);
        }
        .control-group {
            margin-bottom: 1rem;
        }
        .control-group label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 0.35rem;
            color: rgba(180, 220, 255, 0.75);
        }
        #playbackTimelineTime {
            font-size: 0.78rem;
            color: rgba(180, 220, 255, 0.65);
        }
        .control-group textarea {
            width: 100%;
            min-height: 120px;
            resize: vertical;
            border-radius: 0.85rem;
            border: 1px solid rgba(120, 200, 255, 0.25);
            background: rgba(8, 18, 40, 0.85);
            color: #e8f6ff;
            padding: 0.75rem 0.85rem;
            font-size: 0.85rem;
            font-family: 'Fira Code', 'SFMono-Regular', ui-monospace, Menlo, Consolas, 'Liberation Mono', 'Courier New', monospace;
            line-height: 1.5;
        }
        #channelMonitor {
            width: 100%;
            height: 160px;
            display: block;
            border-radius: 0.85rem;
            border: 1px solid rgba(120, 200, 255, 0.18);
            background: rgba(6, 14, 32, 0.65);
        }
        #channelMonitor:focus {
            outline: 2px solid rgba(99, 210, 255, 0.45);
            outline-offset: 2px;
        }
        #developmentTrack {
            border-radius: 0.85rem;
            border: 1px solid rgba(120, 200, 255, 0.18);
            background: rgba(6, 14, 32, 0.55);
            padding: 0.85rem;
            max-height: 220px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.65rem;
        }
        .development-entry {
            border-left: 2px solid rgba(124, 216, 255, 0.4);
            padding-left: 0.75rem;
        }
        .development-entry h3 {
            margin: 0 0 0.35rem;
            font-size: 0.95rem;
            color: #9ed9ff;
            letter-spacing: 0.01em;
        }
        .development-entry p {
            margin: 0.2rem 0;
            font-size: 0.8rem;
            color: rgba(205, 236, 255, 0.85);
            line-height: 1.45;
        }
        .development-highlights {
            margin: 0.2rem 0 0.4rem;
            padding-left: 1rem;
            color: rgba(180, 220, 255, 0.8);
            font-size: 0.78rem;
            line-height: 1.4;
        }
        .development-highlights li {
            margin-bottom: 0.2rem;
        }
        #developmentSummary {
            font-weight: 600;
            color: rgba(180, 220, 255, 0.85);
        }
        .control-group select {
            width: 100%;
            border-radius: 0.85rem;
            border: 1px solid rgba(120, 200, 255, 0.25);
            background: rgba(8, 18, 40, 0.85);
            color: #e8f6ff;
            padding: 0.6rem 0.85rem;
            font-size: 0.85rem;
            font-family: inherit;
            appearance: none;
            cursor: pointer;
        }
        .insight-list {
            list-style: disc;
            margin: 0.35rem 0 0;
            padding-left: 1.25rem;
            color: rgba(205, 236, 255, 0.78);
            font-size: 0.78rem;
            line-height: 1.4;
        }
        .insight-list li {
            margin-bottom: 0.3rem;
        }
        .control-group select:focus {
            outline: 2px solid rgba(99, 210, 255, 0.5);
            outline-offset: 1px;
        }
        .control-group select option {
            background-color: #08152b;
            color: #e8f6ff;
        }
        .control-group input[type="text"],
        .control-group input[type="url"],
        .control-group input[type="number"] {
            width: 100%;
            border-radius: 0.85rem;
            border: 1px solid rgba(120, 200, 255, 0.25);
            background: rgba(8, 18, 40, 0.85);
            color: #e8f6ff;
            padding: 0.6rem 0.85rem;
            font-size: 0.85rem;
            font-family: inherit;
        }
        .control-group input[type="text"]:focus,
        .control-group input[type="url"]:focus,
        .control-group input[type="number"]:focus {
            outline: 2px solid rgba(99, 210, 255, 0.5);
            outline-offset: 1px;
        }
        .button-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            margin-bottom: 1rem;
        }
        button, .toggle-label {
            border: none;
            border-radius: 999px;
            padding: 0.55rem 1.1rem;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            cursor: pointer;
            transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
        }
        button.primary {
            background: linear-gradient(120deg, #3fb8ff, #7c53ff);
            color: #041326;
            box-shadow: 0 10px 25px rgba(64, 180, 255, 0.4);
        }
        button.secondary {
            background: rgba(28, 60, 112, 0.65);
            color: #d0edff;
            border: 1px solid rgba(120, 200, 255, 0.2);
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 26px rgba(64, 180, 255, 0.3);
        }
        button:active {
            transform: translateY(0px) scale(0.99);
        }
        .toggle-label {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(16, 32, 64, 0.6);
            color: #c0e6ff;
            border: 1px solid rgba(120, 200, 255, 0.2);
            padding-right: 0.85rem;
        }
        .toggle-label input {
            accent-color: #49c3ff;
        }
        .slider-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.2rem;
        }
        .slider-row input[type="range"] {
            flex: 1 1 auto;
            accent-color: #49c3ff;
        }
        .slider-row span {
            font-size: 0.8rem;
            color: rgba(180, 220, 255, 0.75);
            min-width: 3ch;
            text-align: right;
        }
        .status-indicator {
            font-size: 0.8rem;
            font-weight: 600;
            color: rgba(124, 216, 255, 0.95);
        }
        .status-indicator.idle {
            color: rgba(160, 200, 240, 0.75);
        }
        .status-indicator.recording {
            color: #7cffa1;
        }
        .status-indicator.paused {
            color: #facc15;
        }
        .status-indicator.playing {
            color: #60a5fa;
        }
        .status-indicator.finished {
            color: #f97316;
        }
        #statusMessage {
            font-size: 0.78rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            color: rgba(124, 216, 255, 0.85);
        }
        #monitorHelper {
            font-size: 0.78rem;
            letter-spacing: 0.02em;
            color: rgba(124, 216, 255, 0.85);
        }
        #uniformPreview {
            font-family: 'Fira Code', 'SFMono-Regular', ui-monospace, Menlo, Consolas, 'Liberation Mono', 'Courier New', monospace;
            font-size: 0.75rem;
            line-height: 1.5;
            border-radius: 0.85rem;
            border: 1px solid rgba(120, 200, 255, 0.18);
            background: rgba(10, 20, 42, 0.75);
            padding: 0.8rem;
            color: rgba(205, 236, 255, 0.9);
            white-space: pre-wrap;
            min-height: 92px;
        }
        #mappingDescription {
            margin-top: 0.45rem;
        }
        .small-print {
            font-size: 0.72rem;
            color: rgba(160, 200, 240, 0.6);
            line-height: 1.4;
        }
        .status-stack {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-bottom: 0.6rem;
        }
        html[data-ppp-embed="true"] #controlPanel,
        html[data-ppp-embed="true"] .control-panel-toggle {
            display: none !important;
        }
        html[data-ppp-embed="true"] #statusMessage,
        html[data-ppp-embed="true"] #uniformPreview,
        html[data-ppp-embed="true"] .small-print {
            display: none !important;
        }
    </style>
</head>
<body>
    <canvas id="visualizerCanvas" aria-label="Hypercube data visualization"></canvas>
    <canvas id="spinorOverlay" aria-hidden="true"></canvas>
    <aside id="controlPanel" aria-label="Data mapper controls">
        <h1>HypercubeCore</h1>
        <p class="description">
            Route arbitrary data streams into a fully generalized 4D renderer. Use the mapper configuration to bind
            channels to the six rotational planes, morphing controls, and lighting parameters, then ignite Sonic Geometry
            Resonance to hear the polytopal motion fold into harmonics.
        </p>

        <div class="control-group">
            <label for="dataInput">
                Input data array
                <span id="channelCount">0 / 32 channels</span>
            </label>
            <textarea id="dataInput" spellcheck="false" aria-describedby="statusMessage"></textarea>
        </div>

        <div class="button-row">
            <button id="applyButton" class="primary" type="button">Apply Data</button>
            <button id="randomizeButton" class="secondary" type="button">Randomize</button>
            <label class="toggle-label">
                <input id="autoStream" type="checkbox" checked>
                Auto Stream
            </label>
        </div>

        <div class="control-group">
            <label for="mappingSelect">
                Mapping preset
                <span id="mappingSource">Resolving…</span>
            </label>
            <select id="mappingSelect" aria-describedby="mappingDescription"></select>
            <p class="small-print" id="mappingDescription">
                Select a preset mapping to remap incoming channels to uniform controls.
            </p>
        </div>

        <div class="button-row">
            <button id="copyUniformButton" class="secondary" type="button">Copy Uniform Snapshot</button>
            <button id="downloadMappingButton" class="secondary" type="button">Download Mapping JSON</button>
        </div>

        <div class="control-group">
            <label for="mappingInput">
                Mapping JSON editor
                <span id="mappingHelper">Synced with active preset</span>
            </label>
            <textarea id="mappingInput" spellcheck="false" rows="8" placeholder="Paste a mapping definition or preset JSON to import."></textarea>
        </div>

        <div class="button-row">
            <button id="applyMappingButton" class="primary" type="button">Import Mapping JSON</button>
            <button id="clearMappingButton" class="secondary" type="button">Clear JSON Editor</button>
        </div>

        <div class="control-group">
            <label for="channelMonitor">
                Channel monitor
                <span id="monitorHelper">Initializing monitor…</span>
            </label>
            <canvas id="channelMonitor" aria-label="Channel monitor visualization"></canvas>
            <p class="small-print">
                Live overview of the latest data channels. Highlighted bars track the default rotation feeds (channels 9–14).
                Configure <code>PPP_CONFIG.monitor</code> to adjust smoothing, value ranges, highlight sets, or disable the monitor.
            </p>
        </div>

        <div class="control-group">
            <label for="developmentTrack">
                Development track
                <span id="developmentSummary">Loading…</span>
            </label>
            <div id="developmentTrack" role="log" aria-live="polite"></div>
            <p class="small-print" id="developmentNotes">
                The most recent session analysis will appear here once the tracker initializes.
            </p>
        </div>

        <div class="slider-row">
            <label for="smoothingSlider" style="flex: 1 1 auto;">Smoothing</label>
            <input id="smoothingSlider" type="range" min="0" max="1" step="0.01" value="0.25" aria-label="Smoothing">
            <span id="smoothingValue">0.25</span>
        </div>

        <div class="control-group">
            <label>
                Data Recorder
                <span id="recorderStatus" class="status-indicator idle">Idle</span>
            </label>
            <div class="button-row">
                <button id="startRecorderButton" class="secondary" type="button">Start Recording</button>
                <button id="stopRecorderButton" class="secondary" type="button">Stop</button>
                <button id="downloadRecorderButton" class="secondary" type="button">Download JSON</button>
                <button id="clearRecorderButton" class="secondary" type="button">Clear</button>
            </div>
            <p id="recorderHelper" class="small-print">
                Capture streamed data arrays with timestamps and optional uniform snapshots. Configure limits via <code>PPP_CONFIG.recorder</code>.
            </p>
        </div>

        <div class="control-group">
            <label>
                Recording Playback
                <span id="playbackStatus" class="status-indicator idle">No recording loaded</span>
            </label>
            <input id="playbackFile" type="file" accept="application/json" style="display: none;">
            <div class="button-row">
                <button id="loadPlaybackButton" class="secondary" type="button">Load JSON</button>
                <button id="playbackPlayButton" class="secondary" type="button">Play</button>
                <button id="playbackPauseButton" class="secondary" type="button">Pause</button>
                <button id="playbackStopButton" class="secondary" type="button">Stop</button>
                <button id="playbackStepButton" class="secondary" type="button">Step ▶</button>
            </div>
            <div class="button-row">
                <label class="toggle-label">
                    <input id="playbackLoopToggle" type="checkbox">
                    Loop
                </label>
                <label class="toggle-label">
                    <input id="playbackUniformToggle" type="checkbox" checked>
                    Apply Uniforms
                </label>
            </div>
            <label for="playbackTimeline">
                Timeline
                <span id="playbackTimelineTime">0.00s / 0.00s</span>
            </label>
            <div class="slider-row">
                <input id="playbackTimeline" type="range" min="0" max="1000" step="1" value="0" aria-label="Playback timeline">
                <span id="playbackTimelineValue">0%</span>
            </div>
            <div class="slider-row">
                <label for="playbackSpeed" style="flex: 1 1 auto;">Playback Speed</label>
                <input id="playbackSpeed" type="range" min="0.25" max="2" step="0.05" value="1" aria-label="Playback speed">
                <span id="playbackSpeedValue">1.00×</span>
            </div>
            <p id="playbackHelper" class="small-print">
                Load a recorder JSON export to replay captured channel streams. Press Space to toggle playback, use ←/→ or Shift+←/→ to step through frames, or drag the timeline slider to navigate.
            </p>
        </div>

        <div class="control-group">
            <label>
                Live Quaternion Stream
                <span id="liveStreamMode" class="status-indicator idle">idle</span>
            </label>
            <div class="status-stack">
                <p id="liveStreamStatus" class="small-print">Live stream idle.</p>
                <p id="liveStreamTelemetry" class="small-print">No live telemetry yet.</p>
            </div>
            <label for="websocketUrl">WebSocket URL</label>
            <input id="websocketUrl" type="url" inputmode="url" placeholder="wss://robot.local:8080/stream">
            <div class="button-row">
                <button id="websocketConnect" class="secondary" type="button">Connect WebSocket</button>
                <button id="serialConnect" class="secondary" type="button">Connect Serial</button>
            </div>
            <label for="serialBaudRate">Serial baud rate</label>
            <select id="serialBaudRate">
                <option value="115200">115,200</option>
                <option value="230400">230,400</option>
                <option value="460800">460,800</option>
                <option value="921600">921,600</option>
            </select>
            <p class="small-print">
                Streams quaternion frames directly into PPP. WebSocket feeds expect JSON frames with <code>matrix</code> or
                <code>planes</code> fields plus optional <code>channels</code>. Serial ingestion reads newline-delimited JSON and
                normalizes values before they hit the mapper, recorder, sonic engine, and PPP APIs.
            </p>
        </div>

        <div class="control-group">
            <label>
                Geometric Audit Telemetry
                <span id="geometricAuditMode" class="status-indicator idle">disabled</span>
            </label>
            <div class="status-stack">
                <p id="geometricAuditSummary" class="small-print">Geometric audit pipeline disabled.</p>
                <p id="geometricAuditAnchor" class="small-print">No batches sealed.</p>
            </div>
            <p class="small-print">
                Enable <code>PPP_CONFIG.geometricAudit</code> to emit hash-linked evidence and Merkle batch summaries from live constellation telemetry.
            </p>
        </div>

        <div class="control-group">
            <label class="toggle-label" for="sonicGeometryToggle">
                <input id="sonicGeometryToggle" type="checkbox">
                Sonic Geometry Resonance
            </label>
            <p id="sonicGeometryHelper" class="small-print">
                Enable to translate polytopal motion into double-quaternion harmonic descriptors with optional resonance audio while the spinor coupler, resonance atlas, signal fabric, transduction grid, metric manifold, topology weave, flux continuum, continuum lattice, and constellation field map the 4D rotation core into harmonic lattices. Streams gating sequences, Hopf fiber telemetry, spinor phase orbits, resonance vectors, carrier matrices, manifold metrics, topology braiding analytics, flux-continuum alignments, lattice synergy reports, constellation dispersion metrics, and bitstream lattices for robotics or multimodal transformers even when muted.
            </p>
            <div class="button-row">
                <label for="sonicGeometryMode" style="flex: 1 1 auto;">Output Mode</label>
                <select id="sonicGeometryMode">
                    <option value="hybrid">Dual Stream (Audio + Data)</option>
                    <option value="analysis">Silent Analysis (Data only)</option>
                </select>
            </div>
            <p id="sonicGeometryModeHelper" class="small-print">
                Dual stream couples resonance audio with quaternion bridges, spinor harmonic lattices, resonance atlas payloads, the spinor signal fabric, transduction grids, metric manifolds, topology weaves, flux continua, continuum lattices, constellation telemetry, and gate density metrics; silent analysis shares the same telemetry without touching the AudioContext—ideal for multimodal transformers.
            </p>
        </div>

        <div id="statusMessage" role="status">Initializing renderer…</div>
        <pre id="uniformPreview">Awaiting data…</pre>

        <div class="control-group">
            <label>
                Calibration Toolkit
                <span id="calibrationStatus" class="status-indicator idle">Calibration idle.</span>
            </label>
            <label for="calibrationSequence">Sequence preset</label>
            <select id="calibrationSequence"></select>
            <div class="button-row">
                <button id="startCalibration" class="primary" type="button">Start Calibration</button>
                <button id="stopCalibration" class="secondary" type="button">Stop</button>
            </div>
            <p class="small-print">
                Captured samples: <span id="calibrationSamples">0</span>
                · Toolkit exports synchronized channel values, uniform snapshots, sonic telemetry, and optional overlay captures
                for dataset tuning loops.
            </p>
        </div>

        <div class="control-group">
            <label>
                Dataset Builder
                <span id="datasetStatus" class="status-indicator idle">Dataset idle.</span>
            </label>
            <p class="small-print">
                Execute the full calibration plan, aggregate parity metrics between the WebGL uniforms and sonic telemetry, and
                export a manifest tuned for multimodal training datasets.
            </p>
            <div class="button-row">
                <button id="runDatasetPlan" class="primary" type="button">Build Dataset</button>
                <button id="downloadDataset" class="secondary" type="button" disabled>Download Manifest</button>
            </div>
            <p id="datasetSummary" class="small-print">No dataset captured yet.</p>
        </div>

        <div class="control-group">
            <label>Dataset Insights</label>
            <p class="small-print">
                Narrative telemetry summarizing fidelity, parity drift, and recommended follow-ups for the multimodal MVP dataset.
            </p>
            <ul id="datasetInsights" class="insight-list">
                <li>Run the dataset plan to generate insights.</li>
            </ul>
        </div>

        <p class="small-print">
            Customize <code>scripts/defaultMapping.js</code> or register runtime presets to integrate additional sensors.
            The <strong>DataMapper</strong> supports scalar/vector uniforms, range remapping, easing, per-channel smoothing,
            and indexed aggregation strategies (average, weighted, RMS, median, and more).
            Provide a <code>window.PPP_CONFIG</code> object before loading this bundle to inject custom mappings or presets,
            initial palette overrides, uniform defaults, channel presets (up to 32 mirrored into the shader), or lifecycle callbacks.
            Configure the channel monitor via <code>PPP_CONFIG.monitor</code> or subscribe to <code>onMonitorUpdate</code> to tap the
            live average and peak statistics. Runtime helpers (e.g. <code>PPP.setMonitorHighlight()</code>) are available after initialization.
            Supply <code>PPP_CONFIG.developmentLog</code> (or call <code>PPP.recordDevelopmentEntry()</code>) to customize the development track
            timeline and capture commentary per session. Use the JSON editor above to import presets during runtime or to export and tweak the active mapping.
        </p>
    </aside>

    <script type="module" src="./scripts/app.js"></script>
</body>
</html>
