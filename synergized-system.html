<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synergized System • Grand Unified Architecture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { color-scheme: dark; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #06101d;
            color: #d8f5ff;
            margin: 0;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(circle at 20% 30%, rgba(220,20,60,0.12), transparent 55%),
                radial-gradient(circle at 80% 15%, rgba(130,95,255,0.10), transparent 50%),
                radial-gradient(circle at 50% 80%, rgba(90,190,255,0.08), transparent 50%),
                linear-gradient(190deg, rgba(4,16,32,0.9), rgba(10,25,48,0.75));
            pointer-events: none;
            z-index: -1;
        }

        /* Moiré Canvas */
        #moire-canvas {
            border-radius: 1rem;
            border: 1px solid rgba(220,20,60,0.3);
            background: #000;
            image-rendering: pixelated;
        }

        /* Cards */
        .sys-card {
            background: rgba(6,20,40,0.88);
            border: 1px solid rgba(104,178,255,0.2);
            border-radius: 1rem;
            padding: 1.25rem;
            box-shadow: 0 22px 50px -34px rgba(0,89,190,0.5);
        }
        .sys-card.engine { border-color: rgba(220,20,60,0.35); }
        .sys-card.bridge { border-color: rgba(255,165,0,0.35); }
        .sys-card.frontend { border-color: rgba(90,190,255,0.35); }
        .sys-card.math { border-color: rgba(130,95,255,0.35); }

        /* Metric bars */
        .metric-bar {
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.08);
            overflow: hidden;
        }
        .metric-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.15s ease-out;
        }

        /* Flow animation */
        .flow-line {
            stroke-dasharray: 8 4;
            animation: flowDash 1s linear infinite;
        }
        @keyframes flowDash {
            to { stroke-dashoffset: -12; }
        }

        /* Petal visualization */
        #petal-canvas {
            border-radius: 1rem;
            border: 1px solid rgba(130,95,255,0.3);
            background: #000;
        }

        /* Status indicators */
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.on { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-dot.off { background: #6b7280; }

        .section-title {
            font-size: 0.75rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: rgba(146,212,255,0.82);
        }

        /* Reservoir sparkline */
        #reservoir-canvas {
            border-radius: 0.5rem;
            background: rgba(0,0,0,0.3);
        }

        /* Timeline scrubber */
        #timeline-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(255,255,255,0.1);
            outline: none;
        }
        #timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; height: 14px;
            border-radius: 50%;
            background: #dc143c;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(220,20,60,0.6);
        }
    </style>
</head>
<body class="antialiased">
    <div class="max-w-7xl mx-auto px-4 md:px-8 py-8 md:py-12 space-y-8">

        <!-- Header -->
        <header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
            <div>
                <p class="section-title">Synergized System Dashboard</p>
                <h1 class="text-3xl md:text-4xl font-extrabold text-white mt-1">The Cybernetic Flower</h1>
                <p class="text-sm text-blue-100/70 mt-1">5-repo Grand Unified Architecture — Live Synthetic Telemetry</p>
            </div>
            <div class="flex items-center gap-4">
                <span class="status-dot on" id="status-dot"></span>
                <span class="text-sm text-green-300/80" id="status-text">Engine Running</span>
                <button id="btn-toggle" class="px-4 py-2 rounded-lg bg-rose-900/60 border border-rose-500/40 text-rose-100 text-sm font-semibold hover:bg-rose-800/60 transition-colors">Pause</button>
                <a href="index.html" class="px-4 py-2 rounded-lg bg-blue-900/40 border border-blue-500/30 text-blue-200 text-sm hover:bg-blue-800/40 transition-colors">Back to PPP</a>
            </div>
        </header>

        <!-- Data Flow Diagram -->
        <div class="sys-card" style="border-color: rgba(255,255,255,0.1); padding: 1rem;">
            <svg viewBox="0 0 900 60" class="w-full" style="max-height:60px">
                <!-- Boxes -->
                <rect x="10" y="15" width="130" height="30" rx="8" fill="rgba(220,20,60,0.15)" stroke="rgba(220,20,60,0.5)" stroke-width="1"/>
                <text x="75" y="35" fill="#ff6b81" font-size="10" text-anchor="middle" font-weight="600">Physics Engine</text>

                <rect x="220" y="15" width="130" height="30" rx="8" fill="rgba(255,165,0,0.12)" stroke="rgba(255,165,0,0.5)" stroke-width="1"/>
                <text x="285" y="35" fill="#ffa726" font-size="10" text-anchor="middle" font-weight="600">WebSocket Bridge</text>

                <rect x="430" y="15" width="130" height="30" rx="8" fill="rgba(90,190,255,0.12)" stroke="rgba(90,190,255,0.5)" stroke-width="1"/>
                <text x="495" y="35" fill="#5ac8ff" font-size="10" text-anchor="middle" font-weight="600">PPP Telemetry</text>

                <rect x="640" y="15" width="130" height="30" rx="8" fill="rgba(130,95,255,0.12)" stroke="rgba(130,95,255,0.5)" stroke-width="1"/>
                <text x="705" y="35" fill="#a78bfa" font-size="10" text-anchor="middle" font-weight="600">Math Core (Cl4,0)</text>

                <rect x="830" y="15" width="60" height="30" rx="8" fill="rgba(34,197,94,0.12)" stroke="rgba(34,197,94,0.5)" stroke-width="1"/>
                <text x="860" y="35" fill="#4ade80" font-size="9" text-anchor="middle" font-weight="600">UI</text>

                <!-- Flow arrows -->
                <line x1="140" y1="30" x2="220" y2="30" stroke="rgba(255,120,120,0.5)" stroke-width="2" class="flow-line"/>
                <line x1="350" y1="30" x2="430" y2="30" stroke="rgba(255,165,0,0.5)" stroke-width="2" class="flow-line"/>
                <line x1="560" y1="30" x2="640" y2="30" stroke="rgba(90,190,255,0.5)" stroke-width="2" class="flow-line"/>
                <line x1="770" y1="30" x2="830" y2="30" stroke="rgba(130,95,255,0.5)" stroke-width="2" class="flow-line"/>
            </svg>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Col 1: Moiré Visualization + Engine Metrics -->
            <div class="space-y-6">
                <div class="sys-card engine">
                    <p class="section-title" style="color:rgba(255,100,120,0.8)">Backend: Physics Reactor</p>
                    <h3 class="text-lg font-bold text-white mt-1 mb-3">Moire Interference</h3>
                    <canvas id="moire-canvas" width="320" height="240" class="w-full"></canvas>
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div>
                            <p class="text-xs text-rose-300/60">Contrast</p>
                            <p class="text-xl font-bold text-rose-100" id="val-contrast">0.00</p>
                            <div class="metric-bar"><div class="metric-fill" id="bar-contrast" style="width:0%;background:linear-gradient(90deg,#dc143c,#ff6b81)"></div></div>
                        </div>
                        <div>
                            <p class="text-xs text-rose-300/60">Frequency</p>
                            <p class="text-xl font-bold text-rose-100" id="val-frequency">0.0 c/mm</p>
                            <div class="metric-bar"><div class="metric-fill" id="bar-frequency" style="width:0%;background:linear-gradient(90deg,#ff4d6d,#ff8fa3)"></div></div>
                        </div>
                    </div>
                </div>

                <div class="sys-card engine">
                    <p class="section-title" style="color:rgba(255,100,120,0.8)">Kirigami Lattice</p>
                    <div class="grid grid-cols-3 gap-2 mt-2">
                        <div class="text-center">
                            <p class="text-xs text-rose-300/50">Flat</p>
                            <p class="text-lg font-bold" id="val-flat" style="color:#22c55e">0%</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-rose-300/50">Half</p>
                            <p class="text-lg font-bold" id="val-half" style="color:#fbbf24">0%</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-rose-300/50">Full</p>
                            <p class="text-lg font-bold" id="val-full" style="color:#ef4444">0%</p>
                        </div>
                    </div>
                    <div class="metric-bar mt-2" style="height:10px">
                        <div style="display:flex;height:100%;border-radius:5px;overflow:hidden">
                            <div id="cell-flat" style="background:#22c55e;width:33%;transition:width 0.2s"></div>
                            <div id="cell-half" style="background:#fbbf24;width:33%;transition:width 0.2s"></div>
                            <div id="cell-full" style="background:#ef4444;width:34%;transition:width 0.2s"></div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p class="text-xs text-rose-300/50">Lattice Stress (Frobenius)</p>
                        <div class="metric-bar mt-1"><div class="metric-fill" id="bar-stress" style="width:0%;background:linear-gradient(90deg,#22c55e,#ef4444)"></div></div>
                    </div>
                </div>
            </div>

            <!-- Col 2: Petal Visualization + Reservoir -->
            <div class="space-y-6">
                <div class="sys-card math">
                    <p class="section-title" style="color:rgba(160,140,255,0.8)">Math Core: Trilatic Flower</p>
                    <h3 class="text-lg font-bold text-white mt-1 mb-3">Petal Rotation (Cl4,0 Rotors)</h3>
                    <canvas id="petal-canvas" width="320" height="320" class="w-full"></canvas>
                    <div class="grid grid-cols-3 gap-2 mt-3 text-center">
                        <div>
                            <div style="width:10px;height:10px;border-radius:50%;background:#dc143c;margin:0 auto"></div>
                            <p class="text-xs text-purple-300/50 mt-1">Alpha</p>
                            <p class="text-sm font-bold text-purple-100" id="val-petal0">0.0</p>
                        </div>
                        <div>
                            <div style="width:10px;height:10px;border-radius:50%;background:#22c55e;margin:0 auto"></div>
                            <p class="text-xs text-purple-300/50 mt-1">Beta</p>
                            <p class="text-sm font-bold text-purple-100" id="val-petal1">0.0</p>
                        </div>
                        <div>
                            <div style="width:10px;height:10px;border-radius:50%;background:#3b82f6;margin:0 auto"></div>
                            <p class="text-xs text-purple-300/50 mt-1">Gamma</p>
                            <p class="text-sm font-bold text-purple-100" id="val-petal2">0.0</p>
                        </div>
                    </div>
                </div>

                <div class="sys-card engine">
                    <p class="section-title" style="color:rgba(255,100,120,0.8)">Reservoir Computing</p>
                    <canvas id="reservoir-canvas" width="320" height="80" class="w-full mt-2"></canvas>
                    <div class="grid grid-cols-3 gap-3 mt-3">
                        <div>
                            <p class="text-xs text-rose-300/50">Entropy</p>
                            <p class="text-sm font-bold text-rose-100" id="val-entropy">0.0 bits</p>
                        </div>
                        <div>
                            <p class="text-xs text-rose-300/50">Lyapunov</p>
                            <p class="text-sm font-bold text-rose-100" id="val-lyapunov">0.00</p>
                        </div>
                        <div>
                            <p class="text-xs text-rose-300/50">Memory</p>
                            <p class="text-sm font-bold text-rose-100" id="val-memory">0%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Col 3: Bridge + PPP Telemetry -->
            <div class="space-y-6">
                <div class="sys-card bridge">
                    <p class="section-title" style="color:rgba(255,180,80,0.8)">Bridge: HemocPythonBridge</p>
                    <h3 class="text-lg font-bold text-white mt-1 mb-3">PPP Channel Map</h3>
                    <div class="space-y-2" id="channel-list"></div>
                </div>

                <div class="sys-card frontend">
                    <p class="section-title" style="color:rgba(120,200,255,0.8)">Frontend: PPP Telemetry</p>
                    <div class="space-y-3 mt-2">
                        <div>
                            <div class="flex justify-between text-xs">
                                <span class="text-blue-300/60">Frames</span>
                                <span class="text-blue-100 font-mono" id="val-frames">0</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs">
                                <span class="text-blue-300/60">Ticks Ingested</span>
                                <span class="text-blue-100 font-mono" id="val-ticks">0</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs">
                                <span class="text-blue-300/60">FPS</span>
                                <span class="text-blue-100 font-mono" id="val-fps">0</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs">
                                <span class="text-blue-300/60">Talbot Mode</span>
                                <span class="text-blue-100 font-mono" id="val-talbot">—</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs">
                                <span class="text-blue-300/60">Logic Polarity</span>
                                <span class="text-blue-100 font-mono" id="val-polarity">—</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sys-card" style="border-color:rgba(34,197,94,0.3)">
                    <p class="section-title" style="color:rgba(100,220,140,0.8)">Time Travel</p>
                    <p class="text-xs text-green-200/50 mt-1">Scrub through recorded frames</p>
                    <input type="range" id="timeline-slider" min="0" max="100" value="100" class="mt-3">
                    <div class="flex justify-between text-xs text-green-200/40 mt-1">
                        <span id="time-start">T-0</span>
                        <span id="time-current">LIVE</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Architecture Reference -->
        <section class="sys-card" style="border-color:rgba(255,255,255,0.1)">
            <p class="section-title">System Architecture</p>
            <div class="grid md:grid-cols-5 gap-4 mt-4">
                <div class="text-center p-3 rounded-lg" style="background:rgba(220,20,60,0.08);border:1px solid rgba(220,20,60,0.2)">
                    <p class="text-rose-300 font-bold text-sm">Backend</p>
                    <p class="text-xs text-rose-200/50 mt-1">HEMOC-SGF</p>
                    <p class="text-xs text-rose-200/40">Python Physics</p>
                </div>
                <div class="text-center p-3 rounded-lg" style="background:rgba(255,165,0,0.08);border:1px solid rgba(255,165,0,0.2)">
                    <p class="text-orange-300 font-bold text-sm">Bridge</p>
                    <p class="text-xs text-orange-200/50 mt-1">WebSocket</p>
                    <p class="text-xs text-orange-200/40">JSON Telemetry</p>
                </div>
                <div class="text-center p-3 rounded-lg" style="background:rgba(90,190,255,0.08);border:1px solid rgba(90,190,255,0.2)">
                    <p class="text-blue-300 font-bold text-sm">Frontend</p>
                    <p class="text-xs text-blue-200/50 mt-1">PPP Spine</p>
                    <p class="text-xs text-blue-200/40">TimeBinder + Feed</p>
                </div>
                <div class="text-center p-3 rounded-lg" style="background:rgba(130,95,255,0.08);border:1px solid rgba(130,95,255,0.2)">
                    <p class="text-purple-300 font-bold text-sm">Math Core</p>
                    <p class="text-xs text-purple-200/50 mt-1">HEMAC + CPE</p>
                    <p class="text-xs text-purple-200/40">Cl(4,0) + E8</p>
                </div>
                <div class="text-center p-3 rounded-lg" style="background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2)">
                    <p class="text-green-300 font-bold text-sm">Demos</p>
                    <p class="text-xs text-green-200/50 mt-1">Rotorary</p>
                    <p class="text-xs text-green-200/40">Pipeline + Viz</p>
                </div>
            </div>
        </section>

        <footer class="text-center text-xs text-blue-200/30 pb-8">
            Synergized System v1.0 — Paul Phillips / Clear Seas Solutions
        </footer>
    </div>

    <!-- ================================================================== -->
    <!-- Synthetic Engine (runs entirely client-side, no server needed)      -->
    <!-- ================================================================== -->
    <script>
    (function() {
        'use strict';

        // --- Synthetic Engine (mirrors backend/engine/websocket_server.py) ---
        const TWO_PI = 2 * Math.PI;
        let frameCount = 0;
        let paused = false;
        let petalAngles = [0, 0, 0];
        const history = [];
        const MAX_HISTORY = 600; // ~20 seconds at 30fps

        // Channel names for the bridge display
        const CHANNEL_NAMES = [
            'moire_contrast', 'moire_frequency', 'lattice_stress',
            'reservoir_entropy', 'reservoir_lyapunov', 'talbot_gap',
            'petal_rotation', 'cell_flat', 'cell_half', 'cell_full',
            'memory_capacity', 'logic_polarity'
        ];
        const CHANNEL_COLORS = [
            '#dc143c', '#ff6b81', '#22c55e',
            '#fbbf24', '#f97316', '#8b5cf6',
            '#a78bfa', '#22c55e', '#fbbf24', '#ef4444',
            '#3b82f6', '#6b7280'
        ];

        // Reservoir sparkline buffer
        const entropyHistory = [];
        const lyapunovHistory = [];
        const SPARK_LEN = 80;

        // FPS tracking
        let lastFpsTime = performance.now();
        let fpsFrames = 0;
        let currentFps = 0;

        function generateFrame() {
            frameCount++;
            const t = frameCount / 30;
            const rates = [0.3, 0.5, 0.7];
            for (let i = 0; i < 3; i++) {
                petalAngles[i] = (petalAngles[i] + rates[i] * 0.033) % TWO_PI;
            }

            const contrast = Math.max(0, Math.min(1, 0.5 + 0.4 * Math.sin(t * 0.8) * Math.cos(t * 1.3)));
            const period = 10 + 5 * Math.sin(t * 0.3);
            const freq = period > 0 ? 1000 / period : 0;
            const stressVals = [
                Math.sin(petalAngles[0]) * 0.5,
                Math.cos(petalAngles[1]) * 0.3,
                Math.sin(petalAngles[2]) * 0.4,
                0, 0, 0, 0, 0, 0
            ];
            const stressFrob = Math.sqrt(stressVals.reduce((s, v) => s + v * v, 0));

            const flat = Math.max(0, Math.min(1, 0.3 + 0.2 * Math.sin(t * 0.5)));
            const half = Math.max(0, Math.min(1, 0.4 + 0.1 * Math.cos(t * 0.7)));
            const full = Math.max(0, 1 - flat - half);

            const entropy = Math.max(0, 4 + 2 * Math.sin(t * 0.2) + 0.5 * Math.sin(t * 1.1));
            const lyapunov = 0.01 + 0.05 * Math.sin(t * 0.15);
            const memoryCap = Math.max(0, Math.min(1, 0.6 + 0.3 * Math.cos(t * 0.1)));
            const isInteger = Math.floor(t * 0.1) % 2 === 0;

            const normFreq = Math.min(1, freq / 100);
            const normStress = Math.min(1, stressFrob / 10);
            const normEntropy = Math.min(1, entropy / 8);
            const normLyapunov = Math.min(1, Math.max(0, lyapunov));
            const normGap = Math.min(1, 25 / 100);
            const meanRot = petalAngles.reduce((a, b) => a + b, 0) / 3;
            const normRot = (meanRot % TWO_PI) / TWO_PI;

            const channels = [
                contrast, normFreq, normStress,
                normEntropy, normLyapunov, normGap,
                normRot, flat, half, full,
                memoryCap, isInteger ? 0 : 1
            ];

            return {
                frame_id: frameCount,
                timestamp: Date.now(),
                contrast, freq, period, stressFrob, normStress,
                flat, half, full,
                entropy, lyapunov, memoryCap,
                gapMode: isInteger ? 'integer' : 'half_integer',
                polarity: isInteger ? 'positive' : 'negative',
                petals: [...petalAngles],
                channels
            };
        }

        // --- Canvas: Moiré Interference ---
        const moireCanvas = document.getElementById('moire-canvas');
        const moireCtx = moireCanvas.getContext('2d');

        function drawMoire(frame) {
            const w = moireCanvas.width, h = moireCanvas.height;
            const img = moireCtx.createImageData(w, h);
            const d = img.data;
            const p0 = frame.petals[0], p1 = frame.petals[1], p2 = frame.petals[2];
            const c = frame.contrast;

            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const nx = x / w, ny = y / h;
                    // Layer 1: primary grating
                    const g1 = Math.sin((nx * 40 + p0 * 5) * TWO_PI) * 0.5 + 0.5;
                    // Layer 2: secondary grating (rotated)
                    const rx = nx * Math.cos(p1) - ny * Math.sin(p1);
                    const g2 = Math.sin((rx * 38 + p1 * 3) * TWO_PI) * 0.5 + 0.5;
                    // Layer 3: tertiary
                    const ry = nx * Math.sin(p2) + ny * Math.cos(p2);
                    const g3 = Math.sin((ry * 42 + p2 * 4) * TWO_PI) * 0.5 + 0.5;

                    // Interference
                    const moire = (g1 * g2 + g2 * g3 + g1 * g3) / 3;
                    const v = moire * c;

                    const idx = (y * w + x) * 4;
                    d[idx]     = Math.floor(v * 220 + (1 - v) * 20);   // R: crimson
                    d[idx + 1] = Math.floor(v * 30);                    // G
                    d[idx + 2] = Math.floor(v * 60 + (1 - v) * 30);    // B
                    d[idx + 3] = 255;
                }
            }
            moireCtx.putImageData(img, 0, 0);
        }

        // --- Canvas: Petal Rotation ---
        const petalCanvas = document.getElementById('petal-canvas');
        const petalCtx = petalCanvas.getContext('2d');

        function drawPetals(frame) {
            const w = petalCanvas.width, h = petalCanvas.height;
            const cx = w / 2, cy = h / 2;
            const r = Math.min(cx, cy) * 0.7;

            petalCtx.fillStyle = '#000';
            petalCtx.fillRect(0, 0, w, h);

            // Draw 24-cell projection hint (hexagonal grid)
            petalCtx.strokeStyle = 'rgba(130,95,255,0.08)';
            petalCtx.lineWidth = 0.5;
            for (let i = 0; i < 6; i++) {
                const a = (i / 6) * TWO_PI;
                petalCtx.beginPath();
                petalCtx.moveTo(cx, cy);
                petalCtx.lineTo(cx + r * 1.2 * Math.cos(a), cy + r * 1.2 * Math.sin(a));
                petalCtx.stroke();
            }

            // Draw three petals
            const colors = ['#dc143c', '#22c55e', '#3b82f6'];
            const names = ['Alpha', 'Beta', 'Gamma'];

            for (let p = 0; p < 3; p++) {
                const baseAngle = (p / 3) * TWO_PI - Math.PI / 2;
                const rot = frame.petals[p];

                petalCtx.save();
                petalCtx.translate(cx, cy);
                petalCtx.rotate(baseAngle + rot);

                // Petal shape (elongated ellipse)
                petalCtx.beginPath();
                petalCtx.ellipse(r * 0.4, 0, r * 0.35, r * 0.12, 0, 0, TWO_PI);
                petalCtx.fillStyle = colors[p] + '30';
                petalCtx.strokeStyle = colors[p] + '80';
                petalCtx.lineWidth = 2;
                petalCtx.fill();
                petalCtx.stroke();

                // Petal spine
                petalCtx.beginPath();
                petalCtx.moveTo(0, 0);
                petalCtx.lineTo(r * 0.75, 0);
                petalCtx.strokeStyle = colors[p] + '60';
                petalCtx.lineWidth = 1;
                petalCtx.stroke();

                // Tip dot
                petalCtx.beginPath();
                petalCtx.arc(r * 0.75, 0, 4, 0, TWO_PI);
                petalCtx.fillStyle = colors[p];
                petalCtx.fill();

                petalCtx.restore();
            }

            // Center dot
            petalCtx.beginPath();
            petalCtx.arc(cx, cy, 5, 0, TWO_PI);
            petalCtx.fillStyle = '#fff';
            petalCtx.fill();

            // Draw angular velocity arcs
            for (let p = 0; p < 3; p++) {
                const baseAngle = (p / 3) * TWO_PI - Math.PI / 2;
                petalCtx.beginPath();
                petalCtx.arc(cx, cy, r * 0.2 + p * 8, baseAngle, baseAngle + frame.petals[p], false);
                petalCtx.strokeStyle = colors[p] + '40';
                petalCtx.lineWidth = 2;
                petalCtx.stroke();
            }
        }

        // --- Canvas: Reservoir Sparkline ---
        const resCanvas = document.getElementById('reservoir-canvas');
        const resCtx = resCanvas.getContext('2d');

        function drawSparkline() {
            const w = resCanvas.width, h = resCanvas.height;
            resCtx.fillStyle = 'rgba(0,0,0,0.3)';
            resCtx.fillRect(0, 0, w, h);

            // Entropy line
            if (entropyHistory.length > 1) {
                resCtx.beginPath();
                for (let i = 0; i < entropyHistory.length; i++) {
                    const x = (i / SPARK_LEN) * w;
                    const y = h - entropyHistory[i] * h;
                    i === 0 ? resCtx.moveTo(x, y) : resCtx.lineTo(x, y);
                }
                resCtx.strokeStyle = '#fbbf24';
                resCtx.lineWidth = 1.5;
                resCtx.stroke();
            }

            // Lyapunov line
            if (lyapunovHistory.length > 1) {
                resCtx.beginPath();
                for (let i = 0; i < lyapunovHistory.length; i++) {
                    const x = (i / SPARK_LEN) * w;
                    const y = h - lyapunovHistory[i] * h * 10; // scale up
                    i === 0 ? resCtx.moveTo(x, y) : resCtx.lineTo(x, y);
                }
                resCtx.strokeStyle = '#f97316';
                resCtx.lineWidth = 1;
                resCtx.stroke();
            }

            // Labels
            resCtx.font = '9px Inter, sans-serif';
            resCtx.fillStyle = '#fbbf2480';
            resCtx.fillText('entropy', 4, 12);
            resCtx.fillStyle = '#f9731680';
            resCtx.fillText('lyapunov', 4, 24);
        }

        // --- Build Channel List ---
        const channelContainer = document.getElementById('channel-list');
        CHANNEL_NAMES.forEach((name, i) => {
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2';
            row.innerHTML = `
                <span class="text-xs font-mono w-3 text-right" style="color:${CHANNEL_COLORS[i]}60">${i}</span>
                <span class="text-xs text-blue-100/50 w-28 truncate">${name}</span>
                <div class="flex-1 metric-bar"><div class="metric-fill" id="ch-${i}" style="width:0%;background:${CHANNEL_COLORS[i]}"></div></div>
                <span class="text-xs font-mono w-10 text-right text-blue-100/40" id="chv-${i}">0.00</span>
            `;
            channelContainer.appendChild(row);
        });

        // --- UI Updates ---
        function updateUI(frame) {
            // Engine metrics
            document.getElementById('val-contrast').textContent = frame.contrast.toFixed(3);
            document.getElementById('bar-contrast').style.width = (frame.contrast * 100) + '%';
            document.getElementById('val-frequency').textContent = frame.freq.toFixed(1) + ' c/mm';
            document.getElementById('bar-frequency').style.width = (Math.min(1, frame.freq / 100) * 100) + '%';

            // Kirigami
            document.getElementById('val-flat').textContent = (frame.flat * 100).toFixed(0) + '%';
            document.getElementById('val-half').textContent = (frame.half * 100).toFixed(0) + '%';
            document.getElementById('val-full').textContent = (frame.full * 100).toFixed(0) + '%';
            document.getElementById('cell-flat').style.width = (frame.flat * 100) + '%';
            document.getElementById('cell-half').style.width = (frame.half * 100) + '%';
            document.getElementById('cell-full').style.width = (frame.full * 100) + '%';
            document.getElementById('bar-stress').style.width = (frame.normStress * 100) + '%';

            // Petals
            for (let i = 0; i < 3; i++) {
                document.getElementById(`val-petal${i}`).textContent = frame.petals[i].toFixed(3) + ' rad';
            }

            // Reservoir
            document.getElementById('val-entropy').textContent = frame.entropy.toFixed(2) + ' bits';
            document.getElementById('val-lyapunov').textContent = frame.lyapunov.toFixed(4);
            document.getElementById('val-memory').textContent = (frame.memoryCap * 100).toFixed(0) + '%';

            // Channels
            frame.channels.forEach((v, i) => {
                const bar = document.getElementById(`ch-${i}`);
                const val = document.getElementById(`chv-${i}`);
                if (bar) bar.style.width = (v * 100) + '%';
                if (val) val.textContent = v.toFixed(2);
            });

            // Telemetry
            document.getElementById('val-frames').textContent = frameCount;
            document.getElementById('val-ticks').textContent = frameCount;
            document.getElementById('val-talbot').textContent = frame.gapMode;
            document.getElementById('val-polarity').textContent = frame.polarity;

            // FPS
            fpsFrames++;
            const now = performance.now();
            if (now - lastFpsTime > 1000) {
                currentFps = Math.round(fpsFrames * 1000 / (now - lastFpsTime));
                fpsFrames = 0;
                lastFpsTime = now;
            }
            document.getElementById('val-fps').textContent = currentFps;

            // Sparklines
            entropyHistory.push(frame.channels[3]);
            lyapunovHistory.push(frame.channels[4]);
            if (entropyHistory.length > SPARK_LEN) entropyHistory.shift();
            if (lyapunovHistory.length > SPARK_LEN) lyapunovHistory.shift();
        }

        // --- Main Loop ---
        let animId;
        let lastRenderTime = 0;
        const TARGET_INTERVAL = 1000 / 30; // 30 FPS

        function loop(timestamp) {
            animId = requestAnimationFrame(loop);
            if (paused) return;
            if (timestamp - lastRenderTime < TARGET_INTERVAL) return;
            lastRenderTime = timestamp;

            const frame = generateFrame();
            history.push(frame);
            if (history.length > MAX_HISTORY) history.shift();

            drawMoire(frame);
            drawPetals(frame);
            updateUI(frame);
            drawSparkline();
        }

        animId = requestAnimationFrame(loop);

        // --- Controls ---
        document.getElementById('btn-toggle').addEventListener('click', function() {
            paused = !paused;
            this.textContent = paused ? 'Resume' : 'Pause';
            document.getElementById('status-dot').className = 'status-dot ' + (paused ? 'off' : 'on');
            document.getElementById('status-text').textContent = paused ? 'Paused' : 'Engine Running';
            document.getElementById('status-text').style.color = paused ? '#9ca3af' : '';
        });

        // Timeline scrubber
        const slider = document.getElementById('timeline-slider');
        slider.addEventListener('input', function() {
            const pct = parseInt(this.value);
            if (pct < 100 && history.length > 0) {
                paused = true;
                document.getElementById('btn-toggle').textContent = 'Resume';
                document.getElementById('status-dot').className = 'status-dot off';
                document.getElementById('status-text').textContent = 'Scrubbing';

                const idx = Math.floor((pct / 100) * (history.length - 1));
                const frame = history[idx];
                drawMoire(frame);
                drawPetals(frame);
                updateUI(frame);
                document.getElementById('time-current').textContent = `Frame ${frame.frame_id}`;
            } else {
                document.getElementById('time-current').textContent = 'LIVE';
                if (paused) {
                    paused = false;
                    document.getElementById('btn-toggle').textContent = 'Pause';
                    document.getElementById('status-dot').className = 'status-dot on';
                    document.getElementById('status-text').textContent = 'Engine Running';
                }
            }
        });
    })();
    </script>
</body>
</html>
